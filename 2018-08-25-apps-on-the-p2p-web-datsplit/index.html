<html class="min-h-full h-full w-full dark" lang="en"><head><title>Gabriel Poça | Apps on the P2P Web - DatSplit</title><meta content="Gabriel Poça | Apps on the P2P Web - DatSplit" name="title"><meta content="Apps on the P2P Web - DatSplit" name="description"><meta content="website" property="og:type"><meta content="https://gabrielpoca.com/2018-08-25-apps-on-the-p2p-web-datsplit/index.html" property="og:url"><meta content="Gabriel Poça | Apps on the P2P Web - DatSplit" property="og:title"><meta content="Apps on the P2P Web - DatSplit" property="og:description"><meta content="https://gabrielpoca.com/https://gabrielpoca.com/2018-08-25-apps-on-the-p2p-web-datsplit/seo.png" property="og:image"><meta content="summary_large_image" property="twitter:card"><meta content="https://gabrielpoca.com/2018-08-25-apps-on-the-p2p-web-datsplit/index.html" property="twitter:url"><meta content="Gabriel Poça | Apps on the P2P Web - DatSplit" property="twitter:title"><meta content="Apps on the P2P Web - DatSplit" property="twitter:description"><meta content="https://gabrielpoca.com/https://gabrielpoca.com/2018-08-25-apps-on-the-p2p-web-datsplit/seo.png" property="twitter:image"><link href="/icon.png" rel="icon" type="image/png"><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1.0" name="viewport"><link rel="stylesheet"  href="/global-Bhqfcltsx5kmVNvWT3DQRw==.css" />
<link rel="stylesheet"  href="/site-mEL6LQbJJlCImN4ZkVYbKg==.css" />
</head><body class="overscroll-none antialiased font-sans min-h-full h-full overflow-x-hidden w-full bg-black-light text-my-white text-base"><header class="flex justify-between px-4 md_px-8 items-center absolute top-0 left-0 w-full z-20 text-my-white"><a href="/" class="flex items-center -mt-1"><img src="/_includes/me small-109857605-256w.png" srcset="/_includes/me small-109857605-64w.png 64w, /_includes/me small-109857605-128w.png 128w, /_includes/me small-109857605-192w.png 192w, /_includes/me small-109857605-256w.png 256w" class="w-8 mr-3"/><span class="invisible sm_visible text-sm font-bold">Gabriel Poça</span></a><nav class="flex justify-end space-x-2 sm_space-x-5 uppercase tracking-widest h-16 items-center z-10 relative text-xs font-bold sm_text-sm"><a href="/" class="font-normal hidden md_block">Home</a><a href="/books" class="font-normal">Reading</a><a href="/music" class="font-normal">Music</a><a href="/now" class="font-normal">Now</a><a href="/about" class="font-normal">About</a></nav></header><article><div class="text-center relative flex items-center justify-center" style="height:85vh"><h1 class="mb-8 text-4xl font-bold z-20 relative px-8 max-w-screen-lg sm_text-5xl">Apps on the P2P Web - DatSplit</h1><div class="overlay absolute top-0 left-0 w-full h-full bg-black z-10 opacity-70"></div><img src="/2018-08-25-apps-on-the-p2p-web-datsplit/_bg-110733711-4256w.jpg" srcset="/2018-08-25-apps-on-the-p2p-web-datsplit/_bg-110733711-1064w.jpg 1064w, /2018-08-25-apps-on-the-p2p-web-datsplit/_bg-110733711-2128w.jpg 2128w, /2018-08-25-apps-on-the-p2p-web-datsplit/_bg-110733711-3192w.jpg 3192w, /2018-08-25-apps-on-the-p2p-web-datsplit/_bg-110733711-4256w.jpg 4256w" class="absolute top-0 left-0 w-full h-full bg-indigo-50 z-0 object-cover object-center"/></div><div class="container pb-32 pt-12"><h2 class="mb-6 section-heading">Blog Post</h2><div class="prose max-w-none prose-lg e-content"><p><em>This blog post is the second in the series Apps on the P2P web. If you are not familiar with Dat or the Beaker Browser, I recommend reading the <a href="/2018-06-04-apps-on-the-p2p-web-beaker-browser">introduction blog post</a> first.</em></p><p>In this blog post, we are building a decentralised clone of <a href="https://www.splitwise.com/">Splitwise</a> that runs on the <a href="https://beakerbrowser.com/">Beaker Browser</a>. Splitwise is a service where a group of people can keep track of shared expenses. You can add expenses to a group, and Splitwise tells you who owes what to whom.</p><p>I’ve selected some features for us to implement that prove that a lot of what Splitwise does can be accomplished in the Beaker Browser:</p><ul><li>Create groups.</li><li>Invite members to a group.</li><li>Join an existing group.</li><li>Add expenses to a group.</li><li>Calculate how much each person owes to the group.</li></ul><p>I’m calling my application <strong>DatSplit</strong>. The <a href="https://github.com/gabrielpoca/datsplit">source code is here</a> and the <a href="dat://datsplit-gabrielpoca.hashbase.io/">application is here</a> (it requires the Beaker Browser).</p><h2>Privacy</h2><p>Our priority is privacy. We have to make sure that only the members of a group can see and share the groups’ data. This is were Dat comes it: each Dat archive is given a public and a private key. You use the public key to share the archive. When you have a public key, Dat will hash it to create a discovery key, that it uses to ask the network for data. This means that only the people you give the public key to will be able to access the information on it.</p><p>Dat guarantees privacy on the network, but what about privacy between groups that have members in common? This an issue that we solve we proper design. In a scenario where you belong to two groups you would have three Dat archives:</p><ul><li>a private archive for the first group</li><li>a private archive for the second group</li><li>and a public archive for DatSplit’s code that anyone can see. The code in this archive will use Beaker Browser’s APIs to create group archives, and it will keep a reference to them in localStorage. As long as those references stay in the localStorage, no one can see it, and the groups stay isolated.</li></ul><h2>What is a group?</h2><p>A group is a list of people and expenses. To be in a group, you need an archive where you can keep track of expenses and members. You and the other members will exchange public keys and add each other in your archives. You will add expenses to your archive, and check the other members’ archives for new expenses, that you will merge into yours. This is how expenses are propagated between members. We can put some mechanisms in place for you to approve expenses from someone else that involve you.</p><h2>What is in a group?</h2><p>With the public key to a Dat archive, you can see every file and folder in it. Each group will a file named <em>data.json</em> where DatSplit keeps track of the expenses and members. We are calling this file the database.</p><p>A member synchronises with the group by looking in the databases of the other members for changes and applying them to his database. To make this process easier our database will be an <a href="http://www.cqrs.nu/Faq/event-sourcing">event store</a>. On an event store, we keep track of changes (events) to our database instead of its current state. A change is an event that indicates that something happened. We never delete the events. If all our database has is a list of events, it’s simple to find what events are new since the last time we checked.</p><p>Our database will have events of the following types:</p><ul><li>Add Peer</li><li>Add Transaction</li></ul><p>We could have other events such as “Approve Peer” and “Approve Transaction” to inform the members of who agree with an action.</p><p>Each event has the following structure:</p><ul><li>unique uuid</li><li>public key of the person who created</li><li>payload</li></ul><p>Here’s an example:</p><pre><code class="json">{
  &quot;type&quot;: &quot;PEER_ADDED&quot;,
  &quot;payload&quot;: {
    &quot;name&quot;: &quot;Gabriel&quot;,
    &quot;url&quot;: &quot;dat://e3503b270839c7df&quot;
  },
  &quot;uuid&quot;: &quot;3ca7665b-b6cd-46f6-8722-743c0a1b2bfa&quot;,
  &quot;url&quot;: &quot;dat://e3503b270839c7df&quot;
}</code></pre><p>We could include a signature of the payload to make sure no one is creating events in someone else’s name. I think the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API">Web Crypto API</a> would be the perfect fit for this.</p><h2>Current state projection</h2><p>Event stores are great to keep track of changes, but they are hard to query. We need the current state of the group so we can build an interface to interact with it. For that, we need a projection that transforms our events into something like this:</p><pre><code class="js">{
  peers: [...]
  transactions: [...]
}</code></pre><p>The projection listens for new events on the event store and processes them to create the current state.</p><pre><code class="js">class Projection {
  constructor(eventStore) {
    this.state = { peers: {}, transactions: {}, name: &quot;Me&quot; };

    eventStore.onChange(this.processEvents);
  }

  processEvents(events) {
    events.map(this.processEvent);
  }

  processEvent(event) {
    const state = { ...this.state };

    switch (event.type) {
      case &quot;TRANSACTION_ADDED&quot;: {
        const { description, from, to, amount, currency, id } = event.payload;

        const transaction = extend({
          description,
          from,
          to,
          amount,
          currency,
          id,
          date: event.timestamp,
        });

        state.transactions[id] = transaction;
        break;
      }
      case &quot;PEER_ADDED&quot;: {
        const { name, url } = event.payload;

        if (!state.peers[url]) {
          state.peers[url] = { name, url };
        }

        break;
      }
      default:
        break;
    }

    this.state = state;
  }

  //more code
}</code></pre><h2>Reading and writing databases</h2><p>Now that we understand the how the database works, we can get our hands dirty with the Beaker Browser’s APIs.</p><p>We start by creating and initializing a group:</p><pre><code class="js">// create dat archive
DatArchive.create({
  title: &quot;My new DatSplit group&quot;,
}).then((archive) =&gt; {
  const { url } = archive;

  // save to localstorage
  const groups = JSON.stringify([url]);
  localStorage.setItem(&quot;DatSplitGroups&quot;, groups);

  // create an event to add the current user
  const addPeerEvent = addPeer(url, {
    name: getName(),
    url,
  });

  // write to data.json an object with an array of events on the key &quot;events&quot;
  archive.writeFile(&quot;data.json&quot;, JSON.stringify({ events: [addPeerEvent] }));
});</code></pre><p>Now that we have a group, we can write events to it:</p><pre><code class="js">// we don&#39;t want to overwrite existing events, so we first read the existing events
const events = JSON.parse(await archive.readFile(&#39;/data.json&#39;)).events

// push a new event
events.push({
  type: &#39;TRANSACTION_ADDED&quot;,
  uuid: newID(), // generates a unique id
  url: url, // current user&#39;s URL
  payload: { ... ], // details about the transaction
  timestamp: new Date(), // current date
})

// write to the database
archive.writeFile(&#39;/data.json&#39;,JSON.stringify({ events }));</code></pre><p>When we exchange public keys with another member, we can read his database and merge new events into ours:</p><pre><code class="js">// instantiate an archive
const member2URL = `...`;
const member2Archive = new DatArchive(member2URL);

// read and filter events we already have
const member2Events = JSON.parse(await member2Archive.readFile(&quot;/data.json&quot;))
  .events;
const newEvents = member2Events.filter(filterNewEvents);

// merge with existing events
events.push(newEvents);

// write to the database
archive.writeFile(&quot;/data.json&quot;, JSON.stringify({ events }));</code></pre><p>This code could run periodically to keep the databases up to date.</p><h2>Conflict Resolution</h2><p>You may be wondering about conflict resolution, but there’s no need for conflict resolution because there are no conflicting updates! The database is an append-only log, and the events’ order is not relevant. We need to keep track of what happened, not when it happened.</p><h2>Closing thoughts</h2><p>The purpose of this blog post is to give a quick overview on what we can do with the Beaker Browser and which APIs to use. I promise to try and answer any question you have. You can find the <a href="https://github.com/gabrielpoca/datsplit">source code here</a> and the <a href="dat://datsplit-gabrielpoca.hashbase.io/">application here</a> (open in the Beaker Browser).</p><p>We could build a lot of functionality on top of these primitives. There could be a system in place where you had to send an event to accept new members or transactions. You could leverage the Web Crypto API to make sure no one is adding events in someone else’s name.</p><p>Unfortunately, the Beaker Browser doesn’t seem to have enough adoption yet to build these type of applications. We could make so much without centralised systems.</p><p>See you next time!</p></div></div></article><div class="h-4 bg-fuchsia-darker w-full"></div><div class="h-4 bg-fuchsia-dark w-full"></div><footer class="relative flex footer-bg-color"><img src="/_includes/footer/bg-27398931-11568w.jpg" srcset="/_includes/footer/bg-27398931-2892w.jpg 2892w, /_includes/footer/bg-27398931-5784w.jpg 5784w, /_includes/footer/bg-27398931-8676w.jpg 8676w, /_includes/footer/bg-27398931-11568w.jpg 11568w" class="absolute bottom-0 left-0 h-full object-left-bottom w-full object-cover xl_object-contain"/><div class="relative container pt-28 pb-52 sm_pt-40 sm_pb-60"><p class="font-bold mb-2">Hey! <br /> Thanks for stopping by.</p><p class="flex-grow mb-2">And feel free to reach out to me on <a href="https://twitter.com/gabrielgpoca" rel="noopener noreferrer" target="_blank" class="underline underline-current-color text-hover-none">Twitter</a> or <a class="underline underline-current-color text-hover-none" href="mailto:mail@gabrielpoca.com">e-mail</a>.<br />I'm always available to listen, talk, share, or brainstorm.</p><p class="flex-grow mb-2">For more information see the <a href="/about" class="underline underline-current-color text-hover-none">about page</a>.</p><p class="flex-grow">You can subscribe to this blog using <a href="/rss.xml" class="underline underline-current-color text-hover-none">RSS</a>.</p></div></footer><script data-goatcounter="https://gabrielpoca.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></body></html>