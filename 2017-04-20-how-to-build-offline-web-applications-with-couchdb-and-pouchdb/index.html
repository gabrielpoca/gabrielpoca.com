<html class="min-h-full h-full w-full" lang="en"><head><title>Gabriel Poça | How to build offline web applications with CouchDB and PouchDB</title><meta content="Gabriel Poça | How to build offline web applications with CouchDB and PouchDB" name="title"><meta content="How to build offline web applications with CouchDB and PouchDB" name="description"><meta content="website" property="og:type"><meta content="https://gabrielpoca.com/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/index.html" property="og:url"><meta content="Gabriel Poça | How to build offline web applications with CouchDB and PouchDB" property="og:title"><meta content="How to build offline web applications with CouchDB and PouchDB" property="og:description"><meta content="https://gabrielpoca.com/https://gabrielpoca.com/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/seo.png" property="og:image"><meta content="summary_large_image" property="twitter:card"><meta content="https://gabrielpoca.com/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/index.html" property="twitter:url"><meta content="Gabriel Poça | How to build offline web applications with CouchDB and PouchDB" property="twitter:title"><meta content="How to build offline web applications with CouchDB and PouchDB" property="twitter:description"><meta content="https://gabrielpoca.com/https://gabrielpoca.com/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/seo.png" property="twitter:image"><link href="/icon.png" rel="icon" type="image/png"><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1.0" name="viewport"><link rel="stylesheet"  href="/global-6gZG2tczcT3JAwqDe3EZkA==.css" />
<link rel="stylesheet"  href="/site--Z1K36JV3z4XqzIgy-g8zw==.css" />
</head><body class="overscroll-none antialiased font-sans min-h-full h-full overflow-x-hidden w-full"><nav class="flex justify-end space-x-3 px-4 uppercase tracking-wide h-16 items-center z-40 relative text-xs font-bold md:px-8 md:space-x-4 md:text-sm text-my-purple"><a href="/" class="opacity-60">Home</a><a href="/books" class="opacity-60">Reading</a><a href="/music" class="opacity-60">Music</a><a href="/now" class="opacity-60">Now</a><a href="/about" class="opacity-60">About</a></nav><article class="bg-black text-my-white h-entry"><div class="text-center relative flex items-center justify-center -mt-16" style="height:80vh"><h1 class="p-name mb-8 text-4xl z-20 relative mx-auto px-8 sm:text-5xl sm:px-16">How to build offline web applications with CouchDB and PouchDB</h1><div class="overlay absolute top-0 left-0 w-full h-full bg-black z-10 opacity-70"></div><img src="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/_bg-48192034-3000w.jpg" srcset="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/_bg-48192034-750w.jpg 750w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/_bg-48192034-1500w.jpg 1500w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/_bg-48192034-2250w.jpg 2250w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/_bg-48192034-3000w.jpg 3000w" class="absolute top-0 left-0 w-full h-full bg-indigo-50 z-0 object-cover object-center"/></div><div class="mx-auto py-8 px-6 sm:max-w-screen-sm"><div class="prose max-w-none prose-lg e-content"><p>You may have heard about <a href="https://developers.google.com/web/fundamentals/getting-started/codelabs/your-first-pwapp/">Progressive Web Apps (PWAs)</a>. These are web applications that leverage the new Web APIs to look and feel like native applications. There is plenty <a href="https://whatwebcando.today/">the web can do today</a> that was only available to native applications before: push notifications; icons on the home screen; offline mode. PWAs are an opportunity to rethink how we build the web and learn from native applications.</p><p>When I first started reading about offline applications, CouchDB was popping up all the time. Offline applications are distributed systems, so we need to take into account data reconciliation and conflict resolution. This is when CouchDB comes into play with an out of the box solution.</p><p>This is the article that I wish I had found when I first started working with CouchDB. It explains how CouchDB works, its limitations, and how we can use it to build offline web applications.</p><h2>Understanding CouchDB</h2><p><a href="http://couchdb.apache.org/">CouchDB</a> is a database. It sells itself with this sentence:</p><p><em>Seamless multi-master sync, that scales from Big Data to Mobile, with an Intuitive HTTP/JSON API and designed for Reliability.</em></p><p>It is confusing; especially the part about <em>Big Data to Mobile</em>. And it doesn’t stop there. Allow me to add some more confusion to the mix with a list of things that come with CouchDB that you wouldn’t expect in a database:</p><ol><li> A built-in reverse proxy</li><li> Support for user accounts, with password hashing and multiple forms of authentication (such as cookies, oauth or tokens).</li><li> Document conflict resolution.</li><li> A changes feed.</li><li> Built-in web interface.</li></ol><p>Some will say that <a href="http://nolanlawson.com/2013/11/15/couchdb-doesnt-want-to-be-your-database-it-wants-to-be-your-web-site">CouchDB is trying to be your application server</a>. For this article, I will focus on what we can use to build offline applications.</p><p>There is another great piece of technology that we need: <a href="http://pouchdb.com">PouchDB</a>. It’s a database inspired by CouchDB, that runs in the browser and allows applications to store data locally, while offline, and later synchronise it with CouchDB.</p><p>Quick recap: CouchDB is a database that you run on your server and has some esoteric capabilities, such as the HTTP/JSON API. CouchDB implements a replication protocol that allows two instances in a cluster to synchronise both ways. PouchDB is a database that runs on the browser and synchronises with CouchDB, like any other instance of a cluster.</p><p>In the following sections I explain how both these technologies work.</p><h3>How data is stored in CouchDB</h3><p>CouchDB is a document-oriented NoSQL database. An instance of CouchDB hosts many databases. Each database can have documents. A document is a JSON object. CouchDB provides a RESTful HTTP API to read and update documents.</p><p>If your CouchDB instance lives in <code class="inline">/couchdb</code>, then one of your databases would live in <code class="inline">/couchdb/database1</code>, and a document would live in <code class="inline">/couchdb/database1/document_id</code>. There are special databases, such as <code class="inline">_users</code> that stores CouchDB’s users. There are also special documents such as <code class="inline">_security</code> that control access to a database.</p><p>CouchDB has views for querying and reporting on documents. Views are defined by JavaScript functions that map keys to values. We can also write reduce functions, in JavaScript, that summarise data.</p><p>Because CouchDB speaks HTTP/JSON we can easily bypass our web server, and make requests to it from the browser. We don’t have to, but that’s what PouchDB expects us to do. When PouchDB syncs, it generates HTTP requests that match CouchDB’s API, so there’s no point in transforming them.</p><p>Is this safe? A database exposed to the world doesn’t sound safe at all, but CouchDB has user accounts and permissions. When PouchDB connects to CouchDB, it needs to send some credentials (password, token, cookie, etc), just like with any other web application.</p><h3>Managing user accounts in CouchDB</h3><p>How do we create accounts in CouchDB? We can have a web application (in Rails or Phoenix) that has admin credentials and exposes an endpoint that validates information and creates accounts in CouchDB. I don’t usually run CouchDB as my primary database; if I’m running Phoenix, my primary database would probably be PostgreSQL, and Phoenix would be responsible for creating user records in PostgreSQL and CouchDB accounts.</p><p>I had a hard time understanding how CouchDB fits in my system, so I made a diagram with the different interactions when registering and authenticating requests.</p><p><img alt="A sequence diagram with the browser, the web application and CouchDB" src="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/diagram-117648135-1244w.png" srcset="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/diagram-117648135-311w.png 311w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/diagram-117648135-622w.png 622w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/diagram-117648135-933w.png 933w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/diagram-117648135-1244w.png 1244w" /></p><p>The first request is made to Phoenix, sending the new user’s email and password. Phoenix will validate both and create an account, inserting a record in PostgreSQL. After, it takes the id of the new user and sends a request to CouchDB to create an account for that user (the id will be his username in CouchDB). It uses the id, not the email, because it needs a value that doesn’t change. Everything up until this point should be in a transaction to make sure there is a CouchDB database for every user.</p><p>When both databases have the user, Phoenix encrypts the user’s id with a key &amp;mdash;that I generated and it’s only known to Phoenix and CouchDB&amp;mdash;, and returns the resulting token to the browser. The browser then takes that token and the user’s id, and uses them to make authenticated requests to CouchDB. Because it has the same key as Phoenix &amp;mdash;the one that only the two of them know&amp;mdash;, it will validate the requests.</p><p>With this we can leverage Phoenix’s authentication system to authorise users in CouchDB. The method described here is called Proxy Authentication and you can read more about it in <a href="http://docs.couchdb.org/en/2.0.0/api/server/authn.html#proxy-authentication">CouchDB’s documentation</a>. There are other authentication mechanisms in CouchDB that could fit your use case better.</p><h3>One database per user</h3><p>CouchDB offers a minimal read level security: databases can have admins and readers, there is no document level security. Because of that, if you grant a user access to the database, he will be able to read every document in it. Doesn’t sound good does it?</p><p>This is why most applications use one database per user. If it seems unreasonable, know <a href="http://mail-archives.apache.org/mod_mbox/couchdb-user/201401.mbox/%3C52CEB873.7080404@ironicdesign.com%3E">it is common to have 100k databases in a Cloudant account</a> (Cloudant is a CouchDB provider). Databases are lightweight.</p><p>In the context of one database per user, know that PouchDB replicates a single database, not the entire instance. Running PouchDB in your client, you need to specify which database you want to replicate from a CouchDB instance. You can run multiple instances of PouchDB, but everything is already prepared to use this level of permissions.</p><p>This works great if you have an app where each user’s data is fairly well segmented. However, as soon as you want to allow a user to access another user’s data, or you want to create aggregate queries across multiple users’ data, the one-database-per-user pattern starts to break down.</p><p>There’s a <a href="https://github.com/etrepum/couchperuser">plugin that automates the creation of a private database for each user</a>, but with CouchDB 2 you only need to <a href="http://docs.couchdb.org/en/2.0.0/config/couch-peruser.html?highlight=per%20user">enable it in the configuration</a>.</p><h3>Data Replication</h3><p>CouchDB is a peer-based distributed database. It allows users to read and update the same data (shared across multiple instances) while disconnected. CouchDB has the ability to synchronise two copies of the same database. If there is a conflict, both revisions will be saved, and a heuristic will determine which revision wins. Both databases will have the same winner, but you can write your own mechanisms of conflict resolution.</p><h3>Configuring CouchDB</h3><p>CouchDB has a built-in web interface called Fauxton. It can be reached at <code class="inline">http://couchdb-url:5984/_utils</code>. Fauxton can be used for setup, configuration, querying, and most administrative tasks.</p><p><img alt="A screenshot of Fauxton" src="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/couchdbweb-78205794-1132w.png" srcset="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/couchdbweb-78205794-283w.png 283w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/couchdbweb-78205794-566w.png 566w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/couchdbweb-78205794-849w.png 849w, /2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/couchdbweb-78205794-1132w.png 1132w" /></p><p>CouchDB can also be configured through a text file at <code class="inline">/etc/couchdb/local.ini</code>. Take the following example of a configuration file:</p><pre><code>[admins]
admin = mysecretpassword

[cors]
origins = http://localhost, https://localhost, http://couch.mydev.name:8080

[couch_peruser]
enable = true</code></pre><p>In this file we create an admin, configure CORS, and enable the plugin that ensures that a private database exist for each document in the <code class="inline">_users</code> database.</p><p>I usually configure CouchDB through this file because it allows me to save it to my repository and quickly create similar instances. CouchDB doesn’t require much configuration and everything works out-of-the-box; you only need to create the first admin. For our offline applications we may need to enable <code class="inline">couch_peruser</code>, but you have to evaluate and decide if you need the private database.</p><h2>Understanding PouchDB</h2><p>PouchDB’s official description, from the docs:</p><p><em>It enables applications to store data locally while offline, then synchronize it with CouchDB and compatible servers when the application is back online, keeping the user’s data in sync no matter where they next login.</em></p><p>PouchDB is a database that runs in the browser and synchronises with CouchDB. It’s not necessary to have CouchDB to use PouchDB, and you can use it just to have a nice abstraction over <a href="https://developer.mozilla.org/en/docs/Web/API/IndexedDB_API">IndexDB</a> and <a href="https://en.wikipedia.org/wiki/Web_SQL_Database">Web SQL</a>.</p><p>I found that CouchDB + PouchDB solves a couple of use-cases well, but becomes unpleasant to work with if you need data that is shared between multiple users and requires different access levels.</p><h3>Getting started with PouchDB</h3><p>In this article I’m not going to build a demonstration application, I’m only going to show the code needed to get started and synchronise an instance of PouchDB with a database in CouchDB.</p><p>We start by requiring creating a local database:</p><pre><code class="javascript">import PouchDB from &quot;pouchdb-browser&quot;;

const db = new PouchDB(&quot;documents&quot;);</code></pre><p>You can create a document in that database:</p><pre><code class="javascript">db.post({ text: &quot;Such a beautiful day&quot; });</code></pre><p>Now that we have a local database, we create another instance of PouchDB that uses a remote storage (CouchDB), instead of Web SQL or IndexDB.</p><pre><code class="javascript">const remoteDatabase = new PouchDB(`http://couchdb-url/documents`);</code></pre><p>Finally, we synchronise the databases both ways.</p><pre><code class="javascript">PouchDB.sync(db, remoteDatabase, {
  live: true,
  heartbeat: false,
  timeout: false,
  retry: true,
});</code></pre><p>In this example I’m enabling replication in both ways and real time. I’m also enabling retry, which will make PouchDB reconnect if the connection goes down. It has a heuristic to choose how much time to wait between reconnection attempts.</p><p>A common question about PouchDB is how much data can we store with it? Chrome, Firefox and Safari are only limited by disk space. You can read more about it in <a href="https://pouchdb.com/faq.html#data_limits">PouchDB’s FAQ</a>.</p><h3>Authenticating with CouchDB</h3><p>If you skimmed over the previous sections, please go back and read the section about CouchDB’s user accounts because the information I present there is important to understand the following examples.</p><p>In our previous example, we synced a local PouchDB database to a CouchDB database, but we didn’t use any form of authentication. In this section we’ll demonstrate how to sync with each user’s private database. Because we enabled a database per user, we know that our users have a private database in CouchDB. The private database is named after the user’s username (which is the user’s id in PostgreSQL) in the following format <code class="inline">userdb-{hex encoded username}</code>.</p><p>We start by creating a database and maybe adding some documents to it:</p><pre><code class="javascript">import PouchDB from &quot;pouchdb-browser&quot;;

const db = new PouchDB(&quot;documents&quot;);

db.post({ text: &quot;Such a beautifull day&quot; });</code></pre><p>I will now assume that you have authenticated your user, and you have his username and CouchDB token (the ones I talked about in the section about CouchDB’s user accounts). Finally, we create a remote database sending the username and token in the AJAX headers.</p><pre><code class="javascript">export sync = (currentUser) =&gt; {
  const remoteDatabase = new PouchDB(`${COUCHDB_URL}/userdb-${hexEncode(currentUser.id)}`, {
    skipSetup: true,
    ajax: {
      headers: {
        &#39;X-Auth-CouchDB-UserName&#39;: `${currentUser.id}`,
        &#39;X-Auth-CouchDB-Roles&#39;: &#39;users&#39;,
        &#39;X-Auth-CouchDB-Token&#39;: currentUser.couchdb_token,
        &#39;Content-Type&#39;: &#39;application/json; charset=utf-8&#39;
      }
    }
  })

  PouchDB.sync(db, remoteDatabase, {
    live: true,
    heartbeat: false,
    timeout: false,
    retry: true
  })
}</code></pre><p>The databases are now in sync. But we didn’t have to wait for it to start querying the database. Once it is instantiated, we can start working with the data we have locally; that is the selling point of offline applications.</p><h2>Hosting and Learning Material</h2><p>There are two more topics I feel obliged to address &amp;mdash;hosting and documentation&amp;mdash; because it is where I think CouchDB falls short.</p><p>I use Heroku a lot. Call me lazy, but when I’m working on a small team, or by myself, I like to know that my application is going to keep running with little maintenance. Heroku doesn’t support CouchDB, and all the CouchDB providers I found are expensive for me. The most popular one seems to be <a href="https://cloudant.com/">Cloudant</a>; you can judge for yourself. For now, I’m running on Digital Ocean, but this isn’t the ideal scenario for me.</p><p>I noticed there aren’t many blog posts on CouchDB; there are a couple of introductory blog posts to PouchDB and that’s it. I also know many companies running CouchDB + PouchDB in production, but there doesn’t seem to be a big open source application we can learn from.</p><p>This isn’t my first attempt at CouchDB + PouchDB. A couple of years ago I walked the same road and gave up. I was about to give up this time too, but to be fair, it was my fault for not paying attention to the documentation, because it’s very thorough. CouchDB’s documentation has been without a doubt a great help.</p><h2>Final words</h2><p>I would recommend CouchDB + PouchDB to anyone building offline experiences. It does not work for every use case, but, when it does, it makes building applications a joy. I also intend to check out the competition: <a href="https://github.com/Kinto/kinto">Kinto</a>. I don’t know yet how different it is from CouchDB, but I would like to know if it shines where CouchDB falls short.</p></div></div><span class="h-card hidden p-author"><a class="p-name u-url" href="/" rel="author me">Gabriel Poça</a><a class="u-photo" href="/icon.png"></a><span class="p-note">Professional software engineer / amateur music maker / avid reader in the process of learning everything I can.</span></span><div class="hidden"><a class="u-url" href="/2017-04-20-how-to-build-offline-web-applications-with-couchdb-and-pouchdb/index.html">How to build offline web applications with CouchDB and PouchDB</a><time class="dt-published" datetime="2017-04-20T00:00:00-00:00">2017-04-20</time></div></article><footer class="py-20 items-end text-xs sm:text-sm bg-black"><div class="bg-my-purple mx-auto px-4 py-10 md:p-8 md:rounded md:container"><div class="flex flex-col sm:flex-row sm:flex-start"><div class="border-2 border-my-purple-darker rounded-full w-24 h-24 overflow-hidden flex-shrink-0 mb-4 sm:mx-auto sm:mb-0"><img src="/_includes/eu-41840077-400w.jpg" srcset="/_includes/eu-41840077-100w.jpg 100w, /_includes/eu-41840077-200w.jpg 200w, /_includes/eu-41840077-300w.jpg 300w, /_includes/eu-41840077-400w.jpg 400w" class="w-full h-full"/></div><div class="flex-grow sm:ml-8"><p class="font-bold mb-1">Hey! <br /> Thanks for stopping by.</p><p class="flex-grow">And feel free to reach out to me on <a href="https://twitter.com/gabrielgpoca" rel="noopener noreferrer" target="_blank" class="underline underline-current-color text-hover-none">Twitter</a> or <a class="underline underline-current-color text-hover-none" href="mailto:mail@gabrielpoca.com">e-mail</a>.<br />I'm always available to listen, talk, share, or brainstorm.</p><p class="flex-grow">For more information see the <a href="/about" class="underline underline-current-color text-hover-none">about page</a>.</p><p class="flex-grow">You can subscribe to this blog using <a href="/rss.xml" class="underline underline-current-color text-hover-none">RSS</a>.</p></div></div></div></footer><span class="h-card hidden p-author"><a class="p-name u-url" href="/" rel="author me">Gabriel Poça</a><a class="u-photo" href="/icon.png"></a><span class="p-note">Professional software engineer / amateur music maker / avid reader in the process of learning everything I can.</span></span><script data-goatcounter="https://gabrielpoca.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script><link href="https://github.com/gabrielpoca" rel="me" /><link rel="webmention" href="https://webmention.io/gabrielpoca.com/webmention" /><link rel="pingback" href="https://webmention.io/gabrielpoca.com/xmlrpc" /></body></html>